<p>æœ‰æ—¶å€™ä½ ä¼šæœ‰ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä½ å¯èƒ½å¸Œæœ›åœ¨å®ƒå®Œæˆä¹‹å‰å–æ¶ˆå®ƒã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œè¯·ä½ ç¼–å†™ä¸€ä¸ªåä¸º <code>cancellable</code> çš„å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå€¼çš„æ•°ç»„ï¼šä¸€ä¸ª <strong>å–æ¶ˆå‡½æ•°</strong> å’Œä¸€ä¸ª <strong>promise</strong> å¯¹è±¡ã€‚</p>

<p>ä½ å¯ä»¥å‡è®¾ç”Ÿæˆå™¨å‡½æ•°åªä¼šç”Ÿæˆ promise å¯¹è±¡ã€‚ä½ çš„å‡½æ•°è´Ÿè´£å°† promise å¯¹è±¡è§£æçš„å€¼ä¼ å›ç”Ÿæˆå™¨ã€‚å¦‚æœ promise è¢«æ‹’ç»ï¼Œä½ çš„å‡½æ•°åº”å°†è¯¥é”™è¯¯æŠ›å›ç»™ç”Ÿæˆå™¨ã€‚</p>

<p>å¦‚æœåœ¨ç”Ÿæˆå™¨å®Œæˆä¹‹å‰è°ƒç”¨äº†å–æ¶ˆå›è°ƒå‡½æ•°ï¼Œåˆ™ä½ çš„å‡½æ•°åº”è¯¥å°†é”™è¯¯æŠ›å›ç»™ç”Ÿæˆå™¨ã€‚è¯¥é”™è¯¯åº”è¯¥æ˜¯å­—ç¬¦ä¸² <code>"Cancelled"</code>ï¼ˆè€Œä¸æ˜¯ä¸€ä¸ª <code>Error</code> å¯¹è±¡ï¼‰ã€‚å¦‚æœé”™è¯¯è¢«æ•è·ï¼Œåˆ™è¿”å›çš„ promise åº”è¯¥è§£æä¸ºä¸‹ä¸€ä¸ªç”Ÿæˆæˆ–è¿”å›çš„å€¼ã€‚å¦åˆ™ï¼Œpromise åº”è¯¥è¢«æ‹’ç»å¹¶æŠ›å‡ºè¯¥é”™è¯¯ã€‚ä¸åº”æ‰§è¡Œä»»ä½•å…¶ä»–ä»£ç ã€‚</p>

<p>å½“ç”Ÿæˆå™¨å®Œæˆæ—¶ï¼Œæ‚¨çš„å‡½æ•°è¿”å›çš„ promise åº”è¯¥è§£æä¸ºç”Ÿæˆå™¨è¿”å›çš„å€¼ã€‚ä½†æ˜¯ï¼Œå¦‚æœç”Ÿæˆå™¨æŠ›å‡ºé”™è¯¯ï¼Œåˆ™è¿”å›çš„ promise åº”è¯¥æ‹’ç»å¹¶æŠ›å‡ºè¯¥é”™è¯¯ã€‚</p>

<p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†ä½ çš„ä»£ç ä¼šå¦‚ä½•è¢«ä½¿ç”¨ï¼š</p>

<pre>
function* tasks() {
  const val = yield new Promise(resolve =&gt; resolve(2 + 2));
  yield new Promise(resolve =&gt; setTimeout(resolve, 100));
  return val + 1; // calculation shouldn't be done.
}
const [cancel, promise] = cancellable(tasks());
setTimeout(cancel, 50);
promise.catch(console.log); // logs "Cancelled" at t=50ms
</pre>

<p>ç›¸åï¼Œå¦‚æœ <code>cancel()</code> æ²¡æœ‰è¢«è°ƒç”¨æˆ–è€…åœ¨ <code>t=100ms</code> ä¹‹åæ‰è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆ promise åº”è¢«è§£æä¸º <code>5</code> ã€‚</p>

<p>&nbsp;</p>

<p><strong>ç¤ºä¾‹ 1ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; return 42; 
}
cancelledAt = 100
<strong>è¾“å‡ºï¼š</strong>{"resolved": 42}
<strong>è§£é‡Šï¼š</strong>
const generator = generatorFunction();
const [cancel, promise] = cancellable(generator);
setTimeout(cancel, 100);
promise.then(console.log); // åœ¨ t=0ms è§£æä¸º 42

è¯¥ç”Ÿæˆå™¨ç«‹å³ç”Ÿæˆ 42 å¹¶å®Œæˆã€‚å› æ­¤ï¼Œè¿”å›çš„ promise ç«‹å³è§£æä¸º 42ã€‚è¯·æ³¨æ„ï¼Œå–æ¶ˆå·²ç»å®Œæˆçš„ç”Ÿæˆå™¨æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚
</pre>

<p><strong>ç¤ºä¾‹ 2ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; const msg = yield new Promise(res =&gt; res("Hello")); 
&nbsp; throw `Error: ${msg}`; 
}
cancelledAt = null
<strong>è¾“å‡ºï¼š</strong>{"rejected": "Error: Hello"}
<strong>è§£é‡Šï¼š</strong>
ä¸€ä¸ª Promise è¢«ç”Ÿæˆã€‚è¯¥å‡½æ•°é€šè¿‡ç­‰å¾… promise è§£æå¹¶å°†è§£æåçš„å€¼ä¼ å›ç”Ÿæˆå™¨æ¥å¤„ç†å®ƒã€‚ç„¶åæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¿™ä¼šå¯¼è‡´ promise è¢«åŒæ ·æŠ›å‡ºçš„é”™è¯¯æ‹’ç»ã€‚
</pre>

<p><strong>ç¤ºä¾‹ 3ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; yield new Promise(res =&gt; setTimeout(res, 200)); 
&nbsp; return "Success"; 
}
cancelledAt = 100
<strong>è¾“å‡ºï¼š</strong>{"rejected": "Cancelled"}
<strong>è§£é‡Šï¼š</strong>
å½“å‡½æ•°ç­‰å¾…è¢«ç”Ÿæˆçš„ promise è§£ææ—¶ï¼Œcancel() è¢«è°ƒç”¨ã€‚è¿™ä¼šå¯¼è‡´ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯è¢«å‘é€å›ç”Ÿæˆå™¨ã€‚ç”±äºè¿™ä¸ªé”™è¯¯æ²¡æœ‰è¢«æ•è·ï¼Œè¿”å›çš„ promise ä¼šå› ä¸ºè¿™ä¸ªé”™è¯¯è€Œè¢«æ‹’ç»ã€‚
</pre>

<p><strong>ç¤ºä¾‹ 4ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; let result = 0; 
&nbsp; yield new Promise(res =&gt; setTimeout(res, 100));
&nbsp; result += yield new Promise(res =&gt; res(1)); 
&nbsp; yield new Promise(res =&gt; setTimeout(res, 100)); 
&nbsp; result += yield new Promise(res =&gt; res(1)); 
&nbsp; return result;
}
cancelledAt = null
<strong>è¾“å‡ºï¼š</strong>{"resolved": 2}
<strong>è§£é‡Šï¼š</strong>
ç”Ÿæˆå™¨ç”Ÿæˆäº† 4 ä¸ª promise ã€‚å…¶ä¸­ä¸¤ä¸ª promise çš„å€¼è¢«æ·»åŠ åˆ°ç»“æœä¸­ã€‚200ms åï¼Œç”Ÿæˆå™¨ä»¥å€¼ 2 å®Œæˆï¼Œè¯¥å€¼è¢«è¿”å›çš„ promise è§£æã€‚
</pre>

<p><strong>ç¤ºä¾‹ 5ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; let result = 0; 
&nbsp; try { 
&nbsp;   yield new Promise(res =&gt; setTimeout(res, 100)); 
&nbsp;   result += yield new Promise(res =&gt; res(1)); 
&nbsp;   yield new Promise(res =&gt; setTimeout(res, 100)); 
&nbsp;   result += yield new Promise(res =&gt; res(1)); 
&nbsp; } catch(e) { 
&nbsp;   return result; 
&nbsp; } 
&nbsp; return result; 
}
cancelledAt = 150
<strong>è¾“å‡ºï¼š</strong>{"resolved": 1}
<strong>è§£é‡Šï¼š</strong>
å‰ä¸¤ä¸ªç”Ÿæˆçš„ promise è§£æå¹¶å¯¼è‡´ç»“æœé€’å¢ã€‚ç„¶è€Œï¼Œåœ¨ t=150ms æ—¶ï¼Œç”Ÿæˆå™¨è¢«å–æ¶ˆäº†ã€‚å‘é€ç»™ç”Ÿæˆå™¨çš„é”™è¯¯è¢«æ•è·ï¼Œç»“æœè¢«è¿”å›å¹¶æœ€ç»ˆç”±è¿”å›çš„ promise è§£æã€‚
</pre>

<p><strong>ç¤ºä¾‹ 6ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
generatorFunction = function*() { 
&nbsp; try { 
&nbsp;   yield new Promise((resolve, reject) =&gt; reject("Promise Rejected")); 
&nbsp; } catch(e) { 
&nbsp;   let a = yield new Promise(resolve =&gt; resolve(2));
    let b = yield new Promise(resolve =&gt; resolve(2)); 
&nbsp;   return a + b; 
&nbsp; }; 
}
cancelledAt = null
<strong>è¾“å‡ºï¼š</strong>{"resolved": 4}
<strong>è§£é‡Šï¼š</strong>
ç¬¬ä¸€ä¸ªç”Ÿæˆçš„ promise ç«‹å³è¢«æ‹’ç»ã€‚è¯¥é”™è¯¯è¢«æ•è·ã€‚å› ä¸ºç”Ÿæˆå™¨æ²¡æœ‰è¢«å–æ¶ˆï¼Œæ‰§è¡Œç»§ç»­åƒå¾€å¸¸ä¸€æ ·ã€‚æœ€ç»ˆè§£æä¸º 2 + 2 = 4ã€‚</pre>

<p>&nbsp;</p>

<p><strong>æç¤ºï¼š</strong></p>

<ul> 
 <li><code>cancelledAt == null or 0 &lt;= cancelledAt &lt;= 1000</code></li> 
 <li><code>generatorFunction</code> è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡</li> 
</ul>

<div><li>ğŸ‘ 10</li><li>ğŸ‘ 0</li></div>